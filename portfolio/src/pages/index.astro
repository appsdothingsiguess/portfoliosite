---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import TechnicalSkills from '../components/TechnicalSkills.astro';
import TopSkills from '../components/TopSkills.astro';

// Determine current mode from URL params (server-side)
const url = Astro.url;
const params = url.searchParams;
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:8',message:'URL params check',data:{url:url.toString(),searchParams:url.search,hasR:params.has('r'),hasB:params.has('b'),hasA:params.has('a'),hasJ:params.has('j'),allParams:Object.fromEntries(params)},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'I'})}).catch(()=>{});
// #endregion
let currentMode: 'research' | 'business' | 'journalism' | 'aba' = 'aba';
const hasExplicitMode = params.has('r') || params.has('b') || params.has('a') || params.has('j');
if (params.has('r')) currentMode = 'research';
if (params.has('b')) currentMode = 'business';
if (params.has('a')) currentMode = 'aba';
if (params.has('j')) currentMode = 'journalism';
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:16',message:'Mode determined',data:{currentMode,hasExplicitMode},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'I'})}).catch(()=>{});
// #endregion

// 1. Fetch Data from Content Collections
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:18',message:'Fetching collections',data:{currentMode},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
// #endregion
const researchDocs = await getCollection('research');
const leadershipDocs = await getCollection('leadership');
const businessDocs = await getCollection('business');
const journalismDocs = await getCollection('journalism');
const skillsDocs = await getCollection('skills');
const modesDocs = await getCollection('modes');
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:24',message:'Collections loaded',data:{modesDocsCount:modesDocs?.length||0,researchCount:researchDocs?.length||0,journalismCount:journalismDocs?.length||0,modesDocIds:modesDocs?.map(d=>d.id)||[]},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
// #endregion

// 2. Always show all experiences (URL params only reorder, not filter)
const filteredResearch = researchDocs || [];
const filteredLeadership = leadershipDocs || [];
const filteredBusiness = businessDocs || [];
const filteredJournalism = journalismDocs || [];

// 3. Sort Data (Newest first)
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:32',message:'Before sorting',data:{researchCount:filteredResearch.length,journalismCount:filteredJournalism.length,researchFirstDate:filteredResearch[0]?.data?.date,researchDateType:typeof filteredResearch[0]?.data?.date,journalismFirstDate:filteredJournalism[0]?.data?.date,journalismDateType:typeof filteredJournalism[0]?.data?.date},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{});
// #endregion
const sortedResearch = filteredResearch.sort((a, b) => {
  const aVal = a.data.date.valueOf();
  const bVal = b.data.date.valueOf();
  // #region agent log
  fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:33',message:'Research sort comparison',data:{aVal,bVal,result:bVal-aVal,aDate:a.data.date,bDate:b.data.date},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'G'})}).catch(()=>{});
  // #endregion
  return bVal - aVal;
});
const sortedJournalism = filteredJournalism.sort((a, b) => {
  const aVal = a.data.date.valueOf();
  const bVal = b.data.date.valueOf();
  // #region agent log
  fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:36',message:'Journalism sort comparison',data:{aVal,bVal,result:bVal-aVal,aDate:a.data.date,bDate:b.data.date},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'G'})}).catch(()=>{});
  // #endregion
  return bVal - aVal;
});
const sortedLeadership = filteredLeadership.sort((a, b) => b.data.dateStart.valueOf() - a.data.dateStart.valueOf());
const sortedBusiness = filteredBusiness.sort((a, b) => b.data.dateStart.valueOf() - a.data.dateStart.valueOf());
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:40',message:'After sorting',data:{sortedResearchFirst:sortedResearch[0]?.data?.title,sortedJournalismFirst:sortedJournalism[0]?.data?.title,sortedResearchDates:sortedResearch.map(r=>r.data.date),sortedJournalismDates:sortedJournalism.map(j=>j.data.date)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H'})}).catch(()=>{});
// #endregion
const sortedSkills = (skillsDocs || []).sort((a, b) => 
  (a.data.order || 999) - (b.data.order || 999)
);

// 4. Hero content based on mode (loaded from modes collection)
const heroContent: Record<string, { badge: { color: string; text: string }; title: string; description: string }> = {};

// Build hero content from modes collection
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:44',message:'Before building heroContent',data:{modesDocsLength:modesDocs?.length||0,currentMode},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'B'})}).catch(()=>{});
// #endregion
if (modesDocs && modesDocs.length > 0) {
  for (const doc of modesDocs) {
    // #region agent log
    fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:47',message:'Processing mode doc',data:{docId:doc?.id,hasData:!!doc?.data,hasBadgeColor:!!doc?.data?.badgeColor,hasBadgeText:!!doc?.data?.badgeText,hasTitle:!!doc?.data?.title,hasDescription:!!doc?.data?.description},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'C'})}).catch(()=>{});
    // #endregion
    if (doc && doc.data && doc.id) {
      // Strip .md extension from doc.id to match currentMode (e.g., "aba.md" -> "aba")
      const modeKey = doc.id.replace(/\.md$/, '');
      heroContent[modeKey] = {
        badge: { 
          color: doc.data.badgeColor || 'bg-green-500', 
          text: doc.data.badgeText || 'Portfolio' 
        },
        title: doc.data.title || 'Professional Portfolio',
        description: doc.data.description || 'Welcome to my portfolio.'
      };
      // #region agent log
      fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:57',message:'Added to heroContent',data:{docId:doc.id,modeKey,heroContentKeys:Object.keys(heroContent)},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'C'})}).catch(()=>{});
      // #endregion
    }
  }
}
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:59',message:'After building heroContent',data:{heroContentKeys:Object.keys(heroContent),currentMode,hasCurrentModeKey:currentMode in heroContent},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'D'})}).catch(()=>{});
// #endregion

// Fallback hero content if mode file is missing
const defaultHero = {
  badge: { color: 'bg-green-500', text: 'Portfolio' },
  title: 'Professional Portfolio',
  description: 'Welcome to my portfolio.'
};

// Get hero content for current mode, with fallback
// Debug: Log to verify collection is loading (remove in production)
if (Object.keys(heroContent).length === 0) {
  console.warn(`[Portfolio] No hero content loaded from modes collection. Modes docs count: ${modesDocs?.length || 0}`);
}

const currentHero = heroContent[currentMode] || defaultHero;
// #region agent log
fetch('http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.astro:74',message:'Selected currentHero',data:{currentMode,usingFallback:!(currentMode in heroContent),currentHeroTitle:currentHero.title,currentHeroDescription:currentHero.description},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'E'})}).catch(()=>{});
// #endregion

// Embed all hero content for client-side mode switching (since static mode doesn't have query params)
const allHeroContent = JSON.stringify(heroContent);
const defaultHeroJson = JSON.stringify(defaultHero);

// 5. Determine section order based on mode (always ends with skills and contact)
function getSectionOrder(mode: typeof currentMode): string[] {
  const baseOrder = {
    research: ['research', 'business', 'leadership', 'journalism'],
    business: ['business', 'leadership', 'journalism', 'research'],
    aba: ['research', 'business', 'leadership', 'journalism'],
    journalism: ['journalism', 'research', 'business', 'leadership']
  };
  return [...baseOrder[mode], 'skills', 'contact'];
}

const sectionOrder = getSectionOrder(currentMode);
---

<BaseLayout title="Joseph Abboud | Researcher & Operator">
  
  <!-- Navigation -->
  <nav class="sticky top-0 z-50 border-b border-border bg-surface/95 backdrop-blur-md">
    <div class="max-w-5xl mx-auto px-6 h-16 flex items-center justify-between">
      <a href="./" class="font-serif font-bold text-xl tracking-tight">Joseph Abboud</a>
      
      <div class="flex items-center gap-3">
        <!-- Mode Dropdown -->
        <div class="relative" id="mode-dropdown">
          <button 
            id="mode-dropdown-button"
            class="btn-secondary px-3 py-2 rounded-lg text-xs font-semibold inline-flex items-center gap-2"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <i id="mode-dropdown-icon" data-lucide="microscope" class="w-4 h-4"></i>
            <span id="mode-dropdown-text" class="hidden sm:inline">Research</span>
            <i data-lucide="chevron-down" class="w-3 h-3 ml-1"></i>
          </button>
          <div 
            id="mode-dropdown-menu"
            class="hidden absolute right-0 mt-2 w-48 rounded-lg border border-border bg-surface shadow-lg z-50"
            role="menu"
          >
            <a 
              href="?a" 
              class="mode-option block px-4 py-2 text-sm hover:bg-surface-2 transition-colors flex items-center gap-2"
              data-mode="aba"
              data-icon="target"
              data-label="ABA"
            >
              <i data-lucide="target" class="w-4 h-4"></i>
              <span>ABA / RBT</span>
            </a>
            <a 
              href="?r" 
              class="mode-option block px-4 py-2 text-sm hover:bg-surface-2 transition-colors flex items-center gap-2"
              data-mode="research"
              data-icon="microscope"
              data-label="Research"
            >
              <i data-lucide="microscope" class="w-4 h-4"></i>
              <span>Research</span>
            </a>
            <a 
              href="?b" 
              class="mode-option block px-4 py-2 text-sm hover:bg-surface-2 transition-colors flex items-center gap-2"
              data-mode="business"
              data-icon="briefcase"
              data-label="Business"
            >
              <i data-lucide="briefcase" class="w-4 h-4"></i>
              <span>Business</span>
            </a>
            <a 
              href="?j" 
              class="mode-option block px-4 py-2 text-sm hover:bg-surface-2 transition-colors flex items-center gap-2"
              data-mode="journalism"
              data-icon="pen-tool"
              data-label="Journalism"
            >
              <i data-lucide="pen-tool" class="w-4 h-4"></i>
              <span>Journalism</span>
            </a>
          </div>
        </div>
        <a href="https://www.linkedin.com/in/joseph-abboud-a870533a3/" target="_blank" class="btn-primary px-3 py-2 rounded-lg text-xs font-semibold inline-flex items-center gap-2">
          <i data-lucide="linkedin" class="w-4 h-4"></i>
          <span class="hidden sm:inline">Connect</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <header class="pt-16 pb-12 md:pt-24 md:pb-20 px-6 border-b border-border bg-gradient-to-b from-[var(--bg)] to-surface-2">
    <div class="max-w-5xl mx-auto flex flex-col-reverse md:flex-row items-center gap-10">
      
      <!-- Dynamic Text Content -->
      <div class="flex-1 text-center md:text-left">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-border bg-surface mb-6 shadow-sm" id="hero-badge">
          <span class={`w-2 h-2 rounded-full ${currentHero.badge.color} animate-pulse`} id="hero-badge-dot"></span>
          <span class="text-xs font-medium text-muted" id="hero-badge-text">{currentHero.badge.text}</span>
        </div>
        
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-serif font-bold leading-[1.1] mb-6 text-balance text-[var(--text)]" id="hero-title" set:html={currentHero.title}></h1>
        
        <p class="text-lg text-muted leading-relaxed max-w-xl mx-auto md:mx-0 mb-8" id="hero-description">
          {currentHero.description}
        </p>

        <div class="flex flex-wrap justify-center md:justify-start gap-4">
          <a href="/assets/pdfs/Resume.pdf" target="_blank" class="btn-secondary px-6 py-3 rounded-xl inline-flex items-center gap-2">
            <i data-lucide="file-text" class="w-4 h-4"></i> Download Resume
          </a>
          <a href="https://www.linkedin.com/in/joseph-abboud-a870533a3/" target="_blank" class="btn-primary px-6 py-3 rounded-xl inline-flex items-center gap-2">
            <i data-lucide="linkedin" class="w-4 h-4"></i> Let's Connect
          </a>
        </div>
      </div>

      <!-- Headshot -->
      <div class="flex-shrink-0 relative group">
        <div class="w-48 h-48 md:w-64 md:h-64 rounded-full border-4 border-surface shadow-2xl overflow-hidden bg-gray-200 relative">
          <!-- User to replace with actual image -->
          <img src="/Images/profile.png" alt="Joseph Abboud" class="w-full h-full object-cover">
        </div>
        <div class="absolute bottom-4 right-4 bg-surface px-3 py-1 rounded-full shadow-lg border border-border flex items-center gap-1.5 animate-bounce" style="animation-duration: 3s;">
          <span class="text-lg">ðŸ’¼</span>
          <span class="text-xs font-bold">Open To Work!</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-6 py-10">
    <style>
      main {
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }
      /* Dynamic ordering: use CSS custom property for flexibility */
      [data-section-order] {
        order: attr(data-section-order number);
      }
      /* Fallback for browsers that don't support attr() in order */
      [data-section-order="0"] { order: 0; }
      [data-section-order="1"] { order: 1; }
      [data-section-order="2"] { order: 2; }
      [data-section-order="3"] { order: 3; }
      [data-section-order="4"] { order: 4; }
      [data-section-order="5"] { order: 5; }
      [data-section-order="998"] { order: 998; }
      [data-section-order="999"] { order: 999; }
    </style>

    <!-- Section: Top Skills (Featured Skills) -->
    <!-- 
      Skills are now derived relationally from experience files.
      A skill appears here if it's referenced in the tools/tags of experience files
      for the current mode (research, business, journalism, aba).
      Set featured: true in skill files to prioritize them in the display.
    -->
    <div id="top-skills-container" data-mode={currentMode}>
      <TopSkills currentMode={currentMode} />
    </div>

    {/* Research Section */}
    <section id="research" data-section-order={sectionOrder.indexOf('research')} class="scroll-mt-24 transition-colors duration-1000 p-4 -m-4 rounded-2xl">
      <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
        <div>
          <h2 class="text-3xl font-serif font-bold mb-2 flex items-center gap-2">
            <i data-lucide="microscope" class="w-6 h-6 text-muted"></i>
            Research & Psychology
          </h2>
          <p class="text-muted max-w-lg">Experimental design, protocol management, and data analysis.</p>
        </div>
      </div>

      <div class="space-y-6">
        {sortedResearch.map((item) => {
          // Generate Summary Headline: Use first finding or methodology first sentence
          const summaryHeadline = item.data.findings?.[0] || 
            (item.data.methodology ? item.data.methodology.split('.')[0] + '.' : 
            (item.data.posterUrl ? "Poster presentation." : 
            "Research project details available."));
          
          return (
            <div class="card p-1">
              <details class="group open:bg-surface-2/30 rounded-xl transition-colors">
                <summary class="p-6 md:p-8 cursor-pointer relative list-none">
                  <div class="flex flex-wrap items-center gap-3 mb-3">
                    <h3 class="text-xl font-serif font-bold group-hover:text-info transition-colors">{item.data.title}</h3>
                    {item.data.organization && (
                      <span class="pill bg-blue-50 text-blue-800 border-blue-200">{item.data.organization}</span>
                    )}
                  </div>
                  {(item.data.dateStart || item.data.date) && (
                    <div class="text-sm text-muted mb-3">
                      {item.data.dateStart ? (
                        <>
                          {item.data.dateStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} - {item.data.dateEnd ? item.data.dateEnd.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'Present'}
                        </>
                      ) : (
                        item.data.date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
                      )}
                    </div>
                  )}
                  <div class="mb-4">
                    <span class="text-xs font-bold uppercase tracking-wider text-muted block mb-2">Relevant Skills</span>
                    <div class="flex flex-wrap gap-2">
                      {item.data.tools.map((tool) => (
                        <span class="pill text-xs">{tool}</span>
                      ))}
                    </div>
                  </div>
                  <p class="text-base font-medium text-[var(--text)] mb-3 leading-snug">
                    {summaryHeadline}
                  </p>
                  {item.data.metrics && item.data.metrics.length > 0 && (
                    <div class="grid grid-cols-3 gap-4 pt-4 mb-4 border-t border-border">
                      {item.data.metrics.map((metric) => (
                        <div>
                          <div class="font-bold text-xl text-[var(--text)]">{metric.value}</div>
                          <div class="text-xs text-muted uppercase tracking-wide">{metric.label}</div>
                        </div>
                      ))}
                    </div>
                  )}
                  <div class="flex items-center gap-2 text-sm font-semibold text-info">
                    <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition-transform"></i>
                    <span class="group-open:hidden">View Full Details</span>
                    <span class="hidden group-open:inline">Hide Details</span>
                  </div>
                </summary>
                <div class="px-6 pb-6 md:px-8 md:pb-8 pt-0 border-t border-border mt-2">
                  <div class="grid md:grid-cols-2 gap-8 pt-6">
                    <div>
                      <h4 class="text-sm font-bold uppercase tracking-wide text-muted mb-3">Methodology</h4>
                      <div class="text-sm text-[var(--text)] leading-relaxed mb-4">
                        {item.body && (
                          <div set:html={item.body} />
                        )}
                        {!item.body && item.data.methodology && (
                          <p>{item.data.methodology}</p>
                        )}
                      </div>
                      {item.data.posterUrl && (
                        <button 
                          onclick={`openPosterModal('${item.data.posterUrl}', '${item.data.title}')`}
                          class="btn-primary px-4 py-2 rounded-lg text-sm inline-flex items-center gap-2"
                        >
                          <i data-lucide="maximize-2" class="w-4 h-4"></i> View Poster PDF
                        </button>
                      )}
                    </div>
                    <div>
                      {item.data.findings && (
                        <>
                          <h4 class="text-sm font-bold uppercase tracking-wide text-muted mb-3">Key Findings</h4>
                          <ul class="list-disc pl-4 space-y-2 text-sm text-[var(--text)]">
                            {item.data.findings.map((point) => (
                              <li>{point}</li>
                            ))}
                          </ul>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </details>
            </div>
          );
        })}
      </div>
    </section>

    {/* Business Section */}
    {sortedBusiness.length > 0 && (
      <section id="business" data-section-order={sectionOrder.indexOf('business')} class="scroll-mt-24 transition-colors duration-1000 p-4 -m-4 rounded-2xl">
        <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
          <div>
            <h2 class="text-3xl font-serif font-bold mb-2 flex items-center gap-2">
              <i data-lucide="briefcase" class="w-6 h-6 text-muted"></i>
              Business Ventures
            </h2>
            <p class="text-muted max-w-lg">E-commerce operations and business development.</p>
          </div>
        </div>

        <div class="space-y-6">
          {sortedBusiness.map((item) => {
            // Generate Summary Headline: First sentence of summary
            const summaryHeadline = item.data.summary.split('.')[0] + '.';
            
            return (
              <div class="card p-1">
                <details class="group open:bg-surface-2/30 rounded-xl transition-colors">
                  <summary class="p-6 md:p-8 cursor-pointer relative list-none">
                    <div class="flex flex-wrap items-center gap-3 mb-3">
                      <h3 class="text-xl font-serif font-bold group-hover:text-info transition-colors">{item.data.role}</h3>
                      <span class="pill bg-blue-50 text-blue-800 border-blue-200">{item.data.organization}</span>
                    </div>
                    <div class="text-sm text-muted mb-3">
                      {item.data.dateStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} - {item.data.dateEnd ? item.data.dateEnd.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'Present'}
                    </div>
                    {item.data.tags && item.data.tags.length > 0 && (
                      <div class="mb-4">
                        <span class="text-xs font-bold uppercase tracking-wider text-muted block mb-2">Relevant Skills</span>
                        <div class="flex flex-wrap gap-2">
                          {item.data.tags.map((tag) => (
                            <span class="pill text-xs">{tag}</span>
                          ))}
                        </div>
                      </div>
                    )}
                    <p class="text-base font-medium text-[var(--text)] mb-3 leading-snug">
                      {summaryHeadline}
                    </p>
                    {item.data.metrics && item.data.metrics.length > 0 && (
                      <div class="grid grid-cols-3 gap-4 pt-4 mb-4 border-t border-border">
                        {item.data.metrics.map((metric) => (
                          <div>
                            <div class="font-bold text-xl text-[var(--text)]">{metric.value}</div>
                            <div class="text-xs text-muted uppercase tracking-wide">{metric.label}</div>
                          </div>
                        ))}
                      </div>
                    )}
                    <div class="flex items-center gap-2 text-sm font-semibold text-info mt-4">
                      <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition-transform"></i>
                      <span class="group-open:hidden">View Full Details</span>
                      <span class="hidden group-open:inline">Hide Details</span>
                    </div>
                  </summary>
                  <div class="px-6 pb-6 md:px-8 md:pb-8 pt-0 border-t border-border mt-2">
                    <div class="pt-6">
                      <div class="text-sm text-[var(--text)] leading-relaxed">
                        {item.body && (
                          <div set:html={item.body} />
                        )}
                        {!item.body && (
                          <p>{item.data.summary}</p>
                        )}
                      </div>
                    </div>
                  </div>
                </details>
              </div>
            );
          })}
        </div>
      </section>
    )}

    {/* Journalism Section */}
    <section id="journalism" data-section-order={sectionOrder.indexOf('journalism')} class="scroll-mt-24 transition-colors duration-1000 p-4 -m-4 rounded-2xl">
      <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
        <div>
          <h2 class="text-3xl font-serif font-bold mb-2 flex items-center gap-2">
            <i data-lucide="newspaper" class="w-6 h-6 text-muted"></i>
            Journalism & Media
          </h2>
          <p class="text-muted max-w-lg">Investigative reporting and multimedia content.</p>
        </div>
      </div>

      {/* Leadership entries with journalism mode */}
      {sortedLeadership.filter(item => item.data.modes?.includes('journalism')).length > 0 && (
        <div class="mb-8 space-y-6">
          {sortedLeadership.filter(item => item.data.modes?.includes('journalism')).map((item) => {
            // Generate Summary Headline: First sentence of summary
            const summaryHeadline = item.data.summary.split('.')[0] + '.';
            
            return (
              <div class="card p-1">
                <details class="group open:bg-surface-2/30 rounded-xl transition-colors">
                  <summary class="p-6 md:p-8 cursor-pointer relative list-none">
                    <div class="flex flex-wrap items-center gap-3 mb-3">
                      <h3 class="text-xl font-serif font-bold group-hover:text-info transition-colors">{item.data.role}</h3>
                      <span class="pill bg-green-50 text-green-800 border-green-200">{item.data.organization}</span>
                    </div>
                    <div class="text-sm text-muted mb-3">
                      {item.data.dateStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} - {item.data.dateEnd ? item.data.dateEnd.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'Present'}
                    </div>
                    {item.data.tags && item.data.tags.length > 0 && (
                      <div class="mb-4">
                        <span class="text-xs font-bold uppercase tracking-wider text-muted block mb-2">Relevant Skills</span>
                        <div class="flex flex-wrap gap-2">
                          {item.data.tags.map((tag) => (
                            <span class="pill text-xs">{tag}</span>
                          ))}
                        </div>
                      </div>
                    )}
                    <p class="text-base font-medium text-[var(--text)] mb-3 leading-snug">
                      {summaryHeadline}
                    </p>
                    {item.data.metrics && item.data.metrics.length > 0 && (
                      <div class="grid grid-cols-3 gap-4 pt-4 mb-4 border-t border-border">
                        {item.data.metrics.map((metric) => (
                          <div>
                            <div class="font-bold text-xl text-[var(--text)]">{metric.value}</div>
                            <div class="text-xs text-muted uppercase tracking-wide">{metric.label}</div>
                          </div>
                        ))}
                      </div>
                    )}
                    <div class="flex items-center gap-2 text-sm font-semibold text-info">
                      <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition-transform"></i>
                      <span class="group-open:hidden">View Full Details</span>
                      <span class="hidden group-open:inline">Hide Details</span>
                    </div>
                  </summary>
                  <div class="px-6 pb-6 md:px-8 md:pb-8 pt-0 border-t border-border mt-2">
                    <div class="pt-6">
                      <div class="text-sm text-[var(--text)] leading-relaxed">
                        {item.body && (
                          <div set:html={item.body} />
                        )}
                        {!item.body && (
                          <p>{item.data.summary}</p>
                        )}
                      </div>
                    </div>
                  </div>
                </details>
              </div>
            );
          })}
        </div>
      )}

      {/* My Journalism Work - First 3 cards always visible, rest in expandable section */}
      <div class="mb-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-serif font-bold">My Journalism Work</h3>
          <div class="flex bg-surface border border-border rounded-full p-1" id="journalism-filter">
            <button 
              data-filter="all" 
              class="journalism-filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-[var(--text)] text-surface transition-all"
            >
              All Content
            </button>
            <button 
              data-filter="Article" 
              class="journalism-filter-btn px-4 py-1.5 rounded-full text-sm font-medium text-muted hover:bg-surface-2 transition-all"
            >
              Articles
            </button>
            <button 
              data-filter="Social" 
              class="journalism-filter-btn px-4 py-1.5 rounded-full text-sm font-medium text-muted hover:bg-surface-2 transition-all"
            >
              Social Media
            </button>
          </div>
        </div>

        {/* First 3 cards - Always visible */}
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="journalism-grid-featured">
          {sortedJournalism.slice(0, 3).map((item, index) => {
            // Generate Summary Headline: Prioritize summary over impact, with fallback
            let summaryHeadline = '';
            if (item.data.summary && item.data.summary.trim()) {
              const firstSentence = item.data.summary.split('.')[0].trim();
              summaryHeadline = firstSentence ? firstSentence + '.' : item.data.summary;
            } else if (item.data.impact) {
              summaryHeadline = item.data.impact;
            } else {
              summaryHeadline = item.data.type === 'Article' ? 'Read the full article for details.' : 'View the post for details.';
            }
            
            return (
              <article 
                class="card p-1 flex flex-col h-full journalism-item" 
                data-type={item.data.type}
              >
                <details class="group flex flex-col h-full open:bg-surface-2/30 rounded-xl transition-colors">
                  <summary class="p-6 flex flex-col h-full cursor-pointer relative list-none">
                    {/* Publication Badge + Year */}
                    <div class="flex justify-between items-center mb-3">
                      <span class={`pill ${item.data.type === 'Article' ? 'bg-blue-50 text-blue-800 border-blue-200' : 'bg-purple-50 text-purple-800 border-purple-200'}`}>
                        {item.data.type === 'Article' ? (
                          <>
                            <i data-lucide="file-text" class="w-3 h-3"></i>
                            <span>{item.data.publication || 'Article'}</span>
                          </>
                        ) : (
                          <>
                            <i data-lucide="instagram" class="w-3 h-3"></i>
                            <span>{item.data.publication || 'Social'}</span>
                          </>
                        )}
                      </span>
                      <span class="text-xs text-muted font-medium">{item.data.date.getFullYear()}</span>
                    </div>
                    
                    {/* Title - Clickable */}
                    <h3 class="text-xl font-serif font-bold mb-3 leading-tight group-hover:text-info transition-colors">
                      <a 
                        href={item.data.url} 
                        target="_blank" 
                        class="hover:underline decoration-brand decoration-2 underline-offset-2 text-[var(--text)]"
                      >
                        {item.data.title}
                      </a>
                    </h3>
                    
                    {/* Summary */}
                    <p class="text-muted text-sm mb-4 flex-grow leading-relaxed line-clamp-3">
                      {item.data.summary}
                    </p>
                    
                    {/* Actions Row */}
                    <div class="mt-auto pt-4 flex items-center border-t border-border">
                      <a 
                        href={item.data.url} 
                        target="_blank" 
                        class="text-xs font-semibold flex items-center gap-1.5 hover:text-info transition-colors"
                      >
                        {item.data.type === 'Article' ? 'Read Article' : 'View Post'} 
                        <i data-lucide="external-link" class="w-3 h-3"></i>
                      </a>
                    </div>
                  </summary>
                  <div class="px-6 pb-6 md:px-8 md:pb-8 pt-0 border-t border-border mt-2">
                    <div class="pt-6">
                      <div class="text-sm text-[var(--text)] leading-relaxed mb-6">
                        {item.body && (
                          <div set:html={item.body} />
                        )}
                        {!item.body && (
                          <p>{item.data.summary}</p>
                        )}
                      </div>
                      {item.data.url && (
                        <a 
                          href={item.data.url} 
                          target="_blank" 
                          class="btn-primary px-4 py-2 rounded-lg text-sm inline-flex items-center gap-2"
                        >
                          {item.data.type === 'Article' ? 'Read Article' : 'View Post'} 
                          <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                      )}
                    </div>
                  </div>
                </details>
              </article>
            );
          })}
        </div>
      </div>

      {/* Remaining cards - Expandable section at bottom */}
      {sortedJournalism.length > 3 && (
        <details class="group mt-6">
          <summary class="cursor-pointer list-none">
            <div class="flex items-center justify-center gap-2 p-4 bg-surface border border-border rounded-xl hover:bg-surface-2 transition-colors">
              <i data-lucide="chevron-down" class="w-5 h-5 text-muted group-open:rotate-180 transition-transform"></i>
              <span class="text-sm font-semibold text-muted">
                View {sortedJournalism.length - 3} More {sortedJournalism.length - 3 === 1 ? 'Item' : 'Items'}
              </span>
            </div>
          </summary>

          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6" id="journalism-grid-remaining">
            {sortedJournalism.slice(3).map((item, index) => {
                // Generate Summary Headline: Prioritize summary over impact, with fallback
                let summaryHeadline = '';
                if (item.data.summary && item.data.summary.trim()) {
                  const firstSentence = item.data.summary.split('.')[0].trim();
                  summaryHeadline = firstSentence ? firstSentence + '.' : item.data.summary;
                } else if (item.data.impact) {
                  summaryHeadline = item.data.impact;
                } else {
                  summaryHeadline = item.data.type === 'Article' ? 'Read the full article for details.' : 'View the post for details.';
                }
                
                return (
                  <article 
                    class="card p-1 flex flex-col h-full journalism-item" 
                    data-type={item.data.type}
                  >
                    <details class="group flex flex-col h-full open:bg-surface-2/30 rounded-xl transition-colors">
                      <summary class="p-6 flex flex-col h-full cursor-pointer relative list-none">
                        {/* Publication Badge + Year */}
                        <div class="flex justify-between items-center mb-3">
                          <span class={`pill ${item.data.type === 'Article' ? 'bg-blue-50 text-blue-800 border-blue-200' : 'bg-purple-50 text-purple-800 border-purple-200'}`}>
                            {item.data.type === 'Article' ? (
                              <>
                                <i data-lucide="file-text" class="w-3 h-3"></i>
                                <span>{item.data.publication || 'Article'}</span>
                              </>
                            ) : (
                              <>
                                <i data-lucide="instagram" class="w-3 h-3"></i>
                                <span>{item.data.publication || 'Social'}</span>
                              </>
                            )}
                          </span>
                          <span class="text-xs text-muted font-medium">{item.data.date.getFullYear()}</span>
                        </div>
                        
                        {/* Title - Clickable */}
                        <h3 class="text-xl font-serif font-bold mb-3 leading-tight group-hover:text-info transition-colors">
                          <a 
                            href={item.data.url} 
                            target="_blank" 
                            class="hover:underline decoration-brand decoration-2 underline-offset-2 text-[var(--text)]"
                          >
                            {item.data.title}
                          </a>
                        </h3>
                        
                        {/* Summary */}
                        <p class="text-muted text-sm mb-4 flex-grow leading-relaxed line-clamp-3">
                          {item.data.summary}
                        </p>
                        
                        {/* Actions Row */}
                        <div class="mt-auto pt-4 flex items-center border-t border-border">
                          <a 
                            href={item.data.url} 
                            target="_blank" 
                            class="text-xs font-semibold flex items-center gap-1.5 hover:text-info transition-colors"
                          >
                            {item.data.type === 'Article' ? 'Read Article' : 'View Post'} 
                            <i data-lucide="external-link" class="w-3 h-3"></i>
                          </a>
                        </div>
                      </summary>
                      <div class="px-6 pb-6 md:px-8 md:pb-8 pt-0 border-t border-border mt-2">
                        <div class="pt-6">
                          <div class="text-sm text-[var(--text)] leading-relaxed mb-6">
                            {item.body && (
                              <div set:html={item.body} />
                            )}
                            {!item.body && (
                              <p>{item.data.summary}</p>
                            )}
                          </div>
                          {item.data.url && (
                            <a 
                              href={item.data.url} 
                              target="_blank" 
                              class="btn-primary px-4 py-2 rounded-lg text-sm inline-flex items-center gap-2"
                            >
                              {item.data.type === 'Article' ? 'Read Article' : 'View Post'} 
                              <i data-lucide="external-link" class="w-4 h-4"></i>
                            </a>
                          )}
                        </div>
                      </div>
                    </details>
                  </article>
                );
              })}
            </div>
          </details>
        )}
    </section>

    <script is:inline>
      // Journalism filter functionality
      (function() {
        const filterButtons = document.querySelectorAll('.journalism-filter-btn');
        const journalismItems = document.querySelectorAll('.journalism-item');
        const remainingSection = document.querySelector('#journalism-grid-remaining')?.closest('details');
        const remainingSummary = remainingSection?.querySelector('summary span');
        
        function filterJournalism(type) {
          let visibleCount = 0;
          let remainingVisibleCount = 0;
          
          journalismItems.forEach((item, index) => {
            const itemType = item.getAttribute('data-type');
            const isInFeatured = index < 3;
            const shouldShow = type === 'all' || itemType === type;
            
            if (shouldShow) {
              item.style.display = '';
              visibleCount++;
              if (!isInFeatured) {
                remainingVisibleCount++;
              }
            } else {
              item.style.display = 'none';
            }
          });
          
          // Update "View X More" text based on visible remaining items
          if (remainingSummary && remainingVisibleCount > 0) {
            remainingSummary.textContent = `View ${remainingVisibleCount} More ${remainingVisibleCount === 1 ? 'Item' : 'Items'}`;
            if (remainingSection) {
              remainingSection.style.display = '';
            }
          } else if (remainingSection) {
            // Hide the expandable section if no remaining items are visible
            remainingSection.style.display = 'none';
          }
          
          // Update button states
          filterButtons.forEach((btn) => {
            const filterType = btn.getAttribute('data-filter');
            if (filterType === type) {
              btn.className = 'journalism-filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-[var(--text)] text-surface transition-all';
            } else {
              btn.className = 'journalism-filter-btn px-4 py-1.5 rounded-full text-sm font-medium text-muted hover:bg-surface-2 transition-all';
            }
          });
        }
        
        filterButtons.forEach((btn) => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const filterType = btn.getAttribute('data-filter');
            filterJournalism(filterType || 'all');
          });
        });
        
        // Re-initialize Lucide icons after filter buttons are set up
        if (typeof lucide !== 'undefined') {
          setTimeout(() => lucide.createIcons(), 100);
        }
      })();
    </script>

    {/* Technical Skills Section - Always second to last */}
    <section id="skills" data-section-order="998" class="scroll-mt-24 transition-colors duration-1000 p-4 -m-4 rounded-2xl">
      <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
        <div>
          <h2 class="text-3xl font-serif font-bold mb-2 flex items-center gap-2">
            <i data-lucide="wrench" class="w-6 h-6 text-muted"></i>
            Technical Toolkit & Certifications
          </h2>
          <p class="text-muted max-w-lg">Software proficiency, research tools, and professional certifications.</p>
        </div>
      </div>

      <TechnicalSkills skills={sortedSkills} />
    </section>

    <!-- Contact - Always last -->
    <section id="contact" data-section-order="999" class="scroll-mt-24 transition-colors duration-1000 p-4 -m-4 rounded-2xl">
      <div class="bg-surface border border-border rounded-2xl p-10 md:p-16 text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-6">Let's Connect.</h2>
        <p class="text-muted max-w-xl mx-auto mb-8 text-lg">
          Currently available for RBT and Research Coordinator roles.
        </p>
        <div class="flex justify-center gap-4">
          <a href="https://www.linkedin.com/in/joseph-abboud-a870533a3/" target="_blank" class="btn-primary px-8 py-4 rounded-xl text-lg inline-flex items-center gap-3 shadow-lg shadow-yellow-500/20">
            <i data-lucide="linkedin" class="w-5 h-5"></i>
            Connect on LinkedIn
          </a>
        </div>
      </div>
      <footer class="mt-16 text-center text-sm text-muted">
        <p>&copy; 2025 Joseph Abboud. Built with Astro & Tailwind.</p>
      </footer>
    </section>

  </main>

  <!-- Poster Modal -->
  <dialog id="poster-modal" class="backdrop:bg-gray-900/50 p-0 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
    <div class="flex flex-col h-full max-h-[90vh] bg-surface">
      <div class="flex-shrink-0 p-4 border-b border-border flex justify-between items-center bg-surface-2">
        <h3 id="poster-modal-title" class="font-bold">Research Poster</h3>
        <form method="dialog"><button class="p-2 hover:bg-border rounded-full" aria-label="Close"><i data-lucide="x" class="w-5 h-5"></i></button></form>
      </div>
      <div class="flex-1 overflow-auto p-4 bg-gray-100 flex justify-center items-start min-h-0">
        <iframe 
          id="poster-iframe"
          src=""
          class="w-full border border-border rounded-lg"
          style="display: none; min-height: 600px; height: 100%;"
          title="Research Poster PDF"
        ></iframe>
        <div id="poster-placeholder" class="text-center">
          <i data-lucide="file-image" class="w-16 h-16 text-muted mx-auto mb-4"></i>
          <p class="text-muted">Loading poster...</p>
        </div>
      </div>
      <div class="flex-shrink-0 p-4 border-t border-border flex justify-end gap-3 bg-surface-2">
        <a 
          id="poster-download-link"
          href=""
          download
          class="btn-secondary px-4 py-2 rounded-lg text-sm inline-flex items-center gap-2"
          style="display: none;"
        >
          <i data-lucide="download" class="w-4 h-4"></i> Download PDF
        </a>
        <form method="dialog">
          <button class="btn-primary px-4 py-2 rounded-lg text-sm inline-flex items-center gap-2">
            Close
          </button>
        </form>
      </div>
    </div>
  </dialog>

  <!-- Poster Modal Script -->
  <script is:inline>
    function openPosterModal(posterUrl, title) {
      const modal = document.getElementById('poster-modal');
      const iframe = document.getElementById('poster-iframe');
      const placeholder = document.getElementById('poster-placeholder');
      const downloadLink = document.getElementById('poster-download-link');
      const modalTitle = document.getElementById('poster-modal-title');
      
      if (!modal || !iframe || !placeholder || !downloadLink || !modalTitle) return;
      
      // Set modal title
      modalTitle.textContent = title || 'Research Poster';
      
      // Set iframe source to PDF
      iframe.src = posterUrl;
      iframe.style.display = 'block';
      placeholder.style.display = 'none';
      
      // Set download link
      downloadLink.href = posterUrl;
      downloadLink.style.display = 'inline-flex';
      
      // Show modal
      modal.showModal();
      
      // Re-initialize Lucide icons after modal opens
      if (typeof lucide !== 'undefined') {
        setTimeout(() => lucide.createIcons(), 100);
      }
    }
    
    // Reset modal when closed
    document.getElementById('poster-modal')?.addEventListener('close', function() {
      const iframe = document.getElementById('poster-iframe');
      const placeholder = document.getElementById('poster-placeholder');
      const downloadLink = document.getElementById('poster-download-link');
      
      if (iframe) {
        iframe.src = '';
        iframe.style.display = 'none';
      }
      if (placeholder) {
        placeholder.style.display = 'block';
      }
      if (downloadLink) {
        downloadLink.href = '';
        downloadLink.style.display = 'none';
      }
    });
  </script>

  <!-- Debug: Monitor Details Elements -->
  <script is:inline>
    // #region agent log
    (function() {
      const logEndpoint = 'http://127.0.0.1:7244/ingest/a7ca4eda-4f6b-42fd-97e8-abf86a8386d5';
      function debugLog(location, message, data, hypothesisId) {
        fetch(logEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            location: location,
            message: message,
            data: data,
            timestamp: Date.now(),
            sessionId: 'debug-session',
            runId: 'run1',
            hypothesisId: hypothesisId
          })
        }).catch(() => {});
      }
      
    })();
    // #endregion
  </script>

  <!-- Embed hero content data for client-side mode switching -->
  <script is:inline define:vars={{allHeroContent, defaultHeroJson}}>
    window.portfolioHeroContent = JSON.parse(allHeroContent);
    window.portfolioDefaultHero = JSON.parse(defaultHeroJson);
  </script>

  <!-- Sticky Chameleon Script -->
  <script is:inline>
    // ============================================
    // PERSISTENT STICKY MODE LOGIC
    // ============================================
    // Hierarchy:
    // 1. Capture Phase: URL params (?a, ?r, ?j, ?b) -> Save to localStorage -> Clean URL
    // 2. Recall Phase: If no URL param -> Check localStorage -> Default to 'aba'
    // 3. Render Phase: Apply mode to Top Skills and UI immediately
    
    const urlParams = new URLSearchParams(window.location.search);
    let currentMode = 'aba'; // Default fallback
    
    // ============================================
    // PHASE 1: CAPTURE (High Priority)
    // ============================================
    // Check for URL parameters and save to localStorage
    if (urlParams.has('a')) {
      currentMode = 'aba';
      localStorage.setItem('portfolioMode', 'aba');
      // Clean URL (remove query param)
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, '', cleanUrl);
    } else if (urlParams.has('r')) {
      currentMode = 'research';
      localStorage.setItem('portfolioMode', 'research');
      // Clean URL (remove query param)
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, '', cleanUrl);
    } else if (urlParams.has('j')) {
      currentMode = 'journalism';
      localStorage.setItem('portfolioMode', 'journalism');
      // Clean URL (remove query param)
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, '', cleanUrl);
    } else if (urlParams.has('b')) {
      currentMode = 'business';
      localStorage.setItem('portfolioMode', 'business');
      // Clean URL (remove query param)
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, '', cleanUrl);
    } else {
      // ============================================
      // PHASE 2: RECALL (Fallback)
      // ============================================
      // No URL param? Check localStorage
      const storedMode = localStorage.getItem('portfolioMode');
      if (storedMode) {
        currentMode = storedMode;
      }
      // If no stored mode, currentMode remains 'aba' (default)
    }

    // ============================================
    // PHASE 3: RENDER
    // ============================================
    // Apply the determined mode immediately to minimize FOUC
    
    // Update Hero Content based on mode (client-side)
    function updateHeroContent(mode) {
      const heroContent = window.portfolioHeroContent || {};
      const defaultHero = window.portfolioDefaultHero || {};
      const hero = heroContent[mode] || defaultHero;
      
      // Update badge
      const badgeDot = document.getElementById('hero-badge-dot');
      const badgeText = document.getElementById('hero-badge-text');
      if (badgeDot && hero.badge) {
        badgeDot.className = `w-2 h-2 rounded-full ${hero.badge.color} animate-pulse`;
      }
      if (badgeText && hero.badge) {
        badgeText.textContent = hero.badge.text;
      }
      
      // Update title
      const titleEl = document.getElementById('hero-title');
      if (titleEl && hero.title) {
        titleEl.innerHTML = hero.title;
      }
      
      // Update description
      const descEl = document.getElementById('hero-description');
      if (descEl && hero.description) {
        descEl.textContent = hero.description;
      }
    }

    // Update section ordering based on mode
    function updateSectionOrder(mode) {
      const sectionOrder = {
        research: ['research', 'business', 'leadership', 'journalism'],
        business: ['business', 'leadership', 'journalism', 'research'],
        aba: ['research', 'business', 'leadership', 'journalism'],
        journalism: ['journalism', 'research', 'business', 'leadership']
      };
      
      const order = sectionOrder[mode] || sectionOrder['aba'];
      const sections = ['research', 'business', 'leadership', 'journalism'];
      
      sections.forEach((sectionId) => {
        const section = document.getElementById(sectionId);
        if (section) {
          const newIndex = order.indexOf(sectionId);
          section.setAttribute('data-section-order', newIndex >= 0 ? newIndex : 999);
        }
      });
    }

    // Update Top Skills mode (filters and renders skills for current mode)
    function updateTopSkillsMode(mode) {
      const topSkillsContainer = document.getElementById('top-skills-container');
      if (topSkillsContainer) {
        topSkillsContainer.setAttribute('data-mode', mode);
        // Dispatch custom event for TopSkills component to react
        const event = new CustomEvent('modechange', { 
          detail: { mode: mode } 
        });
        topSkillsContainer.dispatchEvent(event);
      }
    }
    
    // Apply all updates immediately on page load
    updateHeroContent(currentMode);
    updateSectionOrder(currentMode);
    updateTopSkillsMode(currentMode);

    // Mode Dropdown Functionality
    (function() {
      const dropdownButton = document.getElementById('mode-dropdown-button');
      const dropdownMenu = document.getElementById('mode-dropdown-menu');
      const dropdownIcon = document.getElementById('mode-dropdown-icon');
      const dropdownText = document.getElementById('mode-dropdown-text');
      
      if (!dropdownButton || !dropdownMenu) return;
      
      // Mode configuration
      const modeConfig = {
        'aba': { icon: 'target', label: 'ABA / RBT' },
        'research': { icon: 'microscope', label: 'Research' },
        'business': { icon: 'briefcase', label: 'Business' },
        'journalism': { icon: 'pen-tool', label: 'Journalism' }
      };
      
      // Update dropdown button to show current mode
      function updateDropdownButton(mode) {
        const config = modeConfig[mode] || modeConfig['aba'];
        if (dropdownIcon) {
          dropdownIcon.setAttribute('data-lucide', config.icon);
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }
        if (dropdownText) {
          dropdownText.textContent = config.label;
        }
        
        // Update active state in dropdown menu
        const options = dropdownMenu.querySelectorAll('.mode-option');
        options.forEach(option => {
          const optionMode = option.getAttribute('data-mode');
          if (optionMode === mode) {
            option.classList.add('bg-surface-2', 'font-semibold');
          } else {
            option.classList.remove('bg-surface-2', 'font-semibold');
          }
        });
      }
      
      // Toggle dropdown
      dropdownButton.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = !dropdownMenu.classList.contains('hidden');
        if (isOpen) {
          dropdownMenu.classList.add('hidden');
          dropdownButton.setAttribute('aria-expanded', 'false');
        } else {
          dropdownMenu.classList.remove('hidden');
          dropdownButton.setAttribute('aria-expanded', 'true');
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('mode-dropdown');
        if (dropdown && !dropdown.contains(e.target)) {
          dropdownMenu.classList.add('hidden');
          dropdownButton.setAttribute('aria-expanded', 'false');
        }
      });
      
      // Close dropdown on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !dropdownMenu.classList.contains('hidden')) {
          dropdownMenu.classList.add('hidden');
          dropdownButton.setAttribute('aria-expanded', 'false');
        }
      });
      
      // Handle mode selection (links will handle navigation, but we can close dropdown)
      const modeOptions = dropdownMenu.querySelectorAll('.mode-option');
      modeOptions.forEach(option => {
        option.addEventListener('click', function() {
          dropdownMenu.classList.add('hidden');
          dropdownButton.setAttribute('aria-expanded', 'false');
        });
      });
      
      // Initialize dropdown button with current mode (from Phase 1/2)
      updateDropdownButton(currentMode);
      
      // Update dropdown when mode changes (for client-side mode switching)
      window.addEventListener('modechange', function(e) {
        if (e.detail && e.detail.mode) {
          updateDropdownButton(e.detail.mode);
        }
      });
    })();
  </script>
</BaseLayout>