---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

interface Props {
  currentMode?: 'research' | 'business' | 'journalism' | 'aba';
}

const { currentMode = 'research' } = Astro.props;

// 1. Fetch all skills
const allSkills = await getCollection('skills');

// 2. Filter skills by modes field (if set) or fall back to relational logic
let relevantSkills: typeof allSkills;

// Check if any skills have explicit modes set
const skillsWithModes = allSkills.filter(skill => skill.data.modes && skill.data.modes.length > 0);

if (skillsWithModes.length > 0) {
  // Filter by modes field if set
  relevantSkills = allSkills.filter((skill) => {
    // If skill has modes field set, check if current mode is in the array
    if (skill.data.modes && skill.data.modes.length > 0) {
      return skill.data.modes.includes(currentMode);
    }
    // If no modes field, fall back to relational logic
    return true; // Will be filtered further below
  });
  
  // For skills without explicit modes, use relational logic
  const skillsWithoutModes = relevantSkills.filter(skill => !skill.data.modes || skill.data.modes.length === 0);
  
  if (skillsWithoutModes.length > 0) {
    // Determine context and fetch experience documents for relational matching
    let experienceDocs: Array<CollectionEntry<'research'>> | Array<CollectionEntry<'leadership'>> | Array<CollectionEntry<'business'>> | Array<CollectionEntry<'journalism'>> = [];

    if (currentMode === 'research' || currentMode === 'aba') {
      experienceDocs = await getCollection('research');
    } else if (currentMode === 'business') {
      // Business mode shows skills from both leadership and business experience
      const leadershipDocs = await getCollection('leadership');
      const businessDocs = await getCollection('business');
      experienceDocs = [...leadershipDocs, ...businessDocs] as Array<CollectionEntry<'leadership'>>;
    } else if (currentMode === 'journalism') {
      experienceDocs = await getCollection('journalism');
    }

    // Extract used skill IDs from experience documents
    const usedSkillIds = new Set<string>();

    experienceDocs.forEach((doc) => {
      if (currentMode === 'research' || currentMode === 'aba') {
        // Research uses 'tools' array
        const researchDoc = doc as CollectionEntry<'research'>;
        researchDoc.data.tools?.forEach((tool) => {
          // Add exact match (in case tool is already a slug like "spss-analysis")
          usedSkillIds.add(tool);
          // Normalize tool name to match skill slug (lowercase, hyphenated)
          const normalized = tool.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
          usedSkillIds.add(normalized);
        });
      } else if (currentMode === 'business') {
        // Leadership and Business both use 'tags' array
        // Check if it's a leadership or business doc
        if ('organization' in doc.data && 'tags' in doc.data) {
          const tags = doc.data.tags;
          tags?.forEach((tag) => {
            // Add exact match
            usedSkillIds.add(tag);
            // Normalize tag name to match skill slug
            const normalized = tag.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            usedSkillIds.add(normalized);
          });
        }
      } else if (currentMode === 'journalism') {
        // Journalism doesn't have tools/tags in current schema
        // If needed in future, add logic here
      }
    });

    // Filter skills without modes using relational logic
    const relationallyMatched = skillsWithoutModes.filter((skill) => {
      const skillId = skill.id; // e.g., "spss-analysis"
      
      // Check for exact match
      if (usedSkillIds.has(skillId)) return true;
      
      // Check for partial matches (e.g., "spss" matches "spss-analysis")
      for (const usedId of usedSkillIds) {
        // If tool is "spss" and skill is "spss-analysis", match
        if (skillId.includes(usedId) || usedId.includes(skillId)) {
          return true;
        }
        // Also check if skill name (normalized) matches
        const normalizedSkillName = skill.data.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        if (normalizedSkillName.includes(usedId) || usedId.includes(normalizedSkillName)) {
          return true;
        }
      }
      
      return false;
    });
    
    // Combine skills with explicit modes and relationally matched skills
    const skillsWithExplicitModes = relevantSkills.filter(skill => skill.data.modes && skill.data.modes.length > 0);
    relevantSkills = [...skillsWithExplicitModes, ...relationallyMatched];
  }
} else {
  // No skills have explicit modes, use relational logic for all
  let experienceDocs: Array<CollectionEntry<'research'>> | Array<CollectionEntry<'leadership'>> | Array<CollectionEntry<'business'>> | Array<CollectionEntry<'journalism'>> = [];

  if (currentMode === 'research' || currentMode === 'aba') {
    experienceDocs = await getCollection('research');
  } else if (currentMode === 'business') {
    // Business mode shows skills from both leadership and business experience
    const leadershipDocs = await getCollection('leadership');
    const businessDocs = await getCollection('business');
    experienceDocs = [...leadershipDocs, ...businessDocs] as Array<CollectionEntry<'leadership'>>;
  } else if (currentMode === 'journalism') {
    experienceDocs = await getCollection('journalism');
  }

  // Extract used skill IDs from experience documents
  const usedSkillIds = new Set<string>();

  experienceDocs.forEach((doc) => {
    if (currentMode === 'research' || currentMode === 'aba') {
      // Research uses 'tools' array
      const researchDoc = doc as CollectionEntry<'research'>;
      researchDoc.data.tools?.forEach((tool) => {
        // Add exact match (in case tool is already a slug like "spss-analysis")
        usedSkillIds.add(tool);
        // Normalize tool name to match skill slug (lowercase, hyphenated)
        const normalized = tool.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        usedSkillIds.add(normalized);
      });
    } else if (currentMode === 'business') {
      // Leadership and Business both use 'tags' array
      // Check if it's a leadership or business doc
      if ('organization' in doc.data && 'tags' in doc.data) {
        const tags = doc.data.tags;
        tags?.forEach((tag) => {
          // Add exact match
          usedSkillIds.add(tag);
          // Normalize tag name to match skill slug
          const normalized = tag.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
          usedSkillIds.add(normalized);
        });
      }
    } else if (currentMode === 'journalism') {
      // Journalism doesn't have tools/tags in current schema
      // If needed in future, add logic here
    }
  });

  // Filter skills: Keep only if skill ID (slug) is in usedSkillIds
  relevantSkills = allSkills.filter((skill) => {
    const skillId = skill.id; // e.g., "spss-analysis"
    
    // Check for exact match
    if (usedSkillIds.has(skillId)) return true;
    
    // Check for partial matches (e.g., "spss" matches "spss-analysis")
    for (const usedId of usedSkillIds) {
      // If tool is "spss" and skill is "spss-analysis", match
      if (skillId.includes(usedId) || usedId.includes(skillId)) {
        return true;
      }
      // Also check if skill name (normalized) matches
      const normalizedSkillName = skill.data.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
      if (normalizedSkillName.includes(usedId) || usedId.includes(normalizedSkillName)) {
        return true;
      }
    }
    
    return false;
  });
}

// 5. Sort: featured skills first, then by order
const sortedSkills = relevantSkills.sort((a, b) => {
  // Featured skills come first
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  // Then by order
  return (a.data.order || 999) - (b.data.order || 999);
});

---

<section id="top-skills" class="scroll-mt-24 transition-colors duration-1000 p-4 -m-4 rounded-2xl">
  <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
    <div>
      <h2 class="text-3xl font-serif font-bold mb-2 flex items-center gap-2">
        <i data-lucide="star" class="w-6 h-6 text-muted"></i>
        Top Skills
      </h2>
      <p class="text-muted max-w-lg">
        Core competencies for {currentMode === 'aba' ? 'ABA/Research' : currentMode} roles.
      </p>
    </div>
  </div>

  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="top-skills-grid">
    {sortedSkills.length === 0 ? (
      <div class="md:col-span-3 card p-6 text-center">
        <p class="text-muted mb-2">No skills found for {currentMode} mode.</p>
        <p class="text-sm text-muted">
          Skills appear here when they are referenced in your {currentMode === 'research' || currentMode === 'aba' ? 'research' : currentMode === 'business' ? 'leadership' : 'journalism'} experience files.
        </p>
      </div>
    ) : (
      sortedSkills.map((skill) => {
        return (
          <div 
            class="card p-6 hover:scale-[1.02] transition-all duration-200 top-skill-card"
            data-order={skill.data.order || 999}
          >
            <div class="flex items-start gap-4">
              <div class="flex-shrink-0 bg-surface-2 p-3 rounded-xl border border-border">
                <i data-lucide={skill.data.icon} class="w-6 h-6 text-[var(--text)]" aria-hidden="true"></i>
              </div>
              <div class="flex-grow min-w-0">
                <h3 class="text-lg font-serif font-bold mb-1 text-[var(--text)]">
                  {skill.data.name}
                </h3>
                <p class="text-sm text-muted leading-relaxed mb-3">
                  {skill.data.shortDesc}
                </p>
                <div class="flex items-center gap-2">
                  <span class={`pill ${
                    skill.data.level === 'Certified' 
                      ? 'bg-yellow-50 text-yellow-800 border-yellow-200' 
                      : skill.data.level === 'Advanced'
                      ? 'bg-green-50 text-green-800 border-green-200'
                      : skill.data.level === 'Intermediate'
                      ? 'bg-blue-50 text-blue-800 border-blue-200'
                      : 'bg-gray-50 text-gray-800 border-gray-200'
                  }`}>
                    <i data-lucide="check-circle" class="w-3 h-3" aria-hidden="true"></i>
                    <span>{skill.data.level}</span>
                  </span>
                  {skill.data.featured && (
                    <span class="pill bg-yellow-50 text-yellow-800 border-yellow-200">
                      <i data-lucide="star" class="w-3 h-3" aria-hidden="true"></i>
                      <span>Featured</span>
                    </span>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      })
    )}
  </div>
</section>
